<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無音区間 検出ツール</title>
    <style>
        /* --- 全体のスタイル --- */
        :root {
            --bg-color: #1a1a1e;
            --card-color: #2c2c34;
            --text-color: #f0f0f0;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --border-color: #444;
            --success-color: #28a745;
            --font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 700px;
        }

        h1, h2 {
            text-align: center;
            color: var(--text-color);
            font-weight: 300;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        p {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1rem;
            color: #aaa;
        }

        /* --- カードスタイル --- */
        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        /* --- フォームと設定 --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .setting {
            display: flex;
            flex-direction: column;
        }

        .setting label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #ccc;
        }

        .setting input[type="number"] {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box; /* paddingを含めて幅を計算 */
        }

        /* --- ファイル入力 --- */
        .file-drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-drop-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(0, 123, 255, 0.05);
        }
        .file-drop-area p {
            margin: 0;
            color: #aaa;
        }
        #audioFile {
            display: none; /* 実際のinputは隠す */
        }
        #file-name {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--success-color);
            text-align: center;
        }

        /* --- ボタン --- */
        .btn {
            display: block;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }
        .btn:hover {
            background-color: var(--primary-hover);
        }
        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        /* --- 結果表示 --- */
        #results-container {
            display: none; /* 初期状態では非表示 */
        }
        
        #results-list {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .result-item {
            font-family: 'Menlo', 'Courier New', monospace;
            font-size: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
            color: #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item .duration {
            color: #aaa;
            font-size: 0.9rem;
            margin-left: 1rem;
        }
        
        #audacity-btn {
            background-color: var(--success-color);
            margin-bottom: 1rem;
        }
        #audacity-btn:hover {
            background-color: #218838;
        }
        
        #audacity-labels {
            display: none; /* 初期状態では非表示 */
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Menlo', 'Courier New', monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>無音区間 検出ツール</h1>
        <p>ポッドキャストや音声ファイルの無音・低音量区間を検出します。</p>

        <div class="card">
            <h2>設定</h2>
            <div class="settings-grid">
                <div class="setting">
                    <label for="threshold">無音とみなす音量 (0.0 ~ 1.0)</label>
                    <input type="number" id="threshold" value="0.02" step="0.01" min="0" max="1">
                </div>
                <div class="setting">
                    <label for="min-duration">最小無音時間 (秒)</label>
                    <input type="number" id="min-duration" value="0.5" step="0.1" min="0.1">
                </div>
            </div>

            <label for="audioFile" class="file-drop-area" id="file-drop-area">
                <p>音声ファイル (mp3, wav, m4aなど) を<br>ここにドラッグ＆ドロップ、またはクリックして選択</p>
            </label>
            <input type="file" id="audioFile" accept="audio/*">
            <div id="file-name"></div>

            <button id="analyze-button" class="btn" disabled>解析開始</button>
        </div>

        <div class="card" id="results-container">
            <h2>検出結果</h2>
            <div id="results-list">
                </div>
            
            <button id="audacity-btn" class="btn">Audacity用ラベルを生成</button>
            <textarea id="audacity-labels" rows="10" readonly placeholder="ここにAudacity用ラベルが出力されます..."></textarea>
        </div>

    </div>

    <script>
        // --- DOM要素の取得 ---
        const fileInput = document.getElementById('audioFile');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileNameDisplay = document.getElementById('file-name');
        const analyzeButton = document.getElementById('analyze-button');
        const thresholdInput = document.getElementById('threshold');
        const minDurationInput = document.getElementById('min-duration');
        
        const resultsContainer = document.getElementById('results-container');
        const resultsList = document.getElementById('results-list');
        const audacityBtn = document.getElementById('audacity-btn');
        const audacityLabels = document.getElementById('audacity-labels');

        let audioFile = null;
        let detectedRanges = []; // 検出結果をグローバルに保持
        
        // Web Audio APIの準備
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // --- イベントリスナー ---

        // ファイルが選択された時
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // ドラッグ＆ドロップの処理
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('dragover');
        });
        fileDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
        });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files; // inputにもファイルをセット
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        function handleFile(file) {
            if (file) {
                audioFile = file;
                fileNameDisplay.textContent = `選択中のファイル: ${file.name}`;
                analyzeButton.disabled = false;
            } else {
                audioFile = null;
                fileNameDisplay.textContent = '';
                analyzeButton.disabled = true;
            }
        }

        // 解析ボタンが押された時
        analyzeButton.addEventListener('click', async () => {
            if (!audioFile || !audioContext) return;

            // ボタンを無効化し、ステータスを更新
            analyzeButton.disabled = true;
            analyzeButton.textContent = '解析中...';
            resultsContainer.style.display = 'none';
            resultsList.innerHTML = '<p>解析中です。少々お待ちください...</p>';
            audacityLabels.style.display = 'none';
            audacityLabels.value = '';

            try {
                // 1. ファイルをArrayBufferとして読み込む
                const arrayBuffer = await audioFile.arrayBuffer();
                
                // 2. 音声データをデコード
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // 3. 無音区間を解析
                const threshold = parseFloat(thresholdInput.value);
                const minDuration = parseFloat(minDurationInput.value);
                
                detectedRanges = findSilentRanges(audioBuffer, threshold, minDuration);
                
                // 4. 結果を表示
                displayResults(detectedRanges);

            } catch (error) {
                console.error('音声の解析に失敗しました:', error);
                resultsList.innerHTML = `<p style="color: #ff6b6b;">エラー: 解析に失敗しました。サポートされていないファイル形式の可能性があります。</p>`;
            } finally {
                // ボタンを元に戻す
                analyzeButton.disabled = false;
                analyzeButton.textContent = '解析開始';
                resultsContainer.style.display = 'block';
            }
        });
        
        // Audacityラベル表示ボタン
        audacityBtn.addEventListener('click', () => {
            const labelContent = generateAudacityLabels(detectedRanges);
            audacityLabels.value = labelContent;
            audacityLabels.style.display = 'block';
            audacityLabels.select(); // ユーザーがコピーしやすいように全選択
        });

        // --- 音声解析ロジック ---

        /**
         * AudioBufferから無音区間を検出する
         * @param {AudioBuffer} buffer - デコードされた音声バッファ
         * @param {number} threshold - 無音とみなす音量 (RMS)
         * @param {number} minDuration - 最小の無音時間 (秒)
         * @returns {Array<{start: number, end: number}>} - 無音区間の配列
         */
        function findSilentRanges(buffer, threshold, minDuration) {
            // モノラル/ステレオを考慮し、全チャンネルのデータをミックスダウン（平均化）する
            // もしくは、簡略化のためチャンネル0（左）のみを使用する
            const data = buffer.getChannelData(0); // チャンネル0のデータを取得
            const sampleRate = buffer.sampleRate;
            const minSilentSamples = sampleRate * minDuration;
            
            // 音声データを小さなスライス（例: 100ms）に分割して解析
            const sliceDuration = 0.1; // 0.1秒ごとにチェック
            const samplesPerSlice = Math.floor(sampleRate * sliceDuration);
            
            const silentRanges = [];
            let isSilent = false;
            let silenceStartTime = 0; // 秒単位

            for (let i = 0; i < data.length; i += samplesPerSlice) {
                const sliceEnd = Math.min(i + samplesPerSlice, data.length);
                const slice = data.slice(i, sliceEnd);
                
                // スライスのRMS（実効値）を計算して音量を判断
                let sumOfSquares = 0;
                for (let j = 0; j < slice.length; j++) {
                    sumOfSquares += slice[j] * slice[j];
                }
                const rms = Math.sqrt(sumOfSquares / slice.length);

                if (rms < threshold) {
                    // --- 無音区間 ---
                    if (!isSilent) {
                        // 無音区間に入った瞬間
                        isSilent = true;
                        silenceStartTime = i / sampleRate; // 開始時間を記録
                    }
                } else {
                    // --- 音声あり区間 ---
                    if (isSilent) {
                        // 無音区間が終わった瞬間
                        isSilent = false;
                        const silenceEndTime = i / sampleRate; // 終了時間を記録
                        
                        // 最小無音時間を超えているかチェック
                        if (silenceEndTime - silenceStartTime >= minDuration) {
                            silentRanges.push({ start: silenceStartTime, end: silenceEndTime });
                        }
                    }
                }
            }
            
            // ファイルの最後が無音だった場合の処理
            if (isSilent) {
                const silenceEndTime = data.length / sampleRate;
                if (silenceEndTime - silenceStartTime >= minDuration) {
                    silentRanges.push({ start: silenceStartTime, end: silenceEndTime });
                }
            }

            return silentRanges;
        }

        // --- 表示用ヘルパー関数 ---

        /**
         * 検出結果をリストに表示する
         * @param {Array<{start: number, end: number}>} ranges 
         */
        function displayResults(ranges) {
            if (ranges.length === 0) {
                resultsList.innerHTML = '<p>無音区間は見つかりませんでした。</p>';
                audacityBtn.style.display = 'none'; // ボタンを隠す
                return;
            }
            
            audacityBtn.style.display = 'block'; // ボタンを表示
            
            resultsList.innerHTML = ''; // リストをクリア
            ranges.forEach(range => {
                const startStr = formatTime(range.start);
                const endStr = formatTime(range.end);
                const duration = (range.end - range.start).toFixed(2);

                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <strong>${startStr}</strong> 〜 <strong>${endStr}</strong>
                    <span class="duration">(${duration}秒間)</span>
                `;
                resultsList.appendChild(item);
            });
        }
        
        /**
         * Audacity用ラベルファイルを生成する
         * @param {Array<{start: number, end: number}>} ranges 
         */
        function generateAudacityLabels(ranges) {
            let labelContent = '';
            ranges.forEach((range, index) => {
                // Audacity形式: start (sec) [TAB] end (sec) [TAB] label_name
                const start = range.start.toFixed(6); // Audacityは小数点以下6桁を好む
                const end = range.end.toFixed(6);
                const label = `無音 ${index + 1}`;
                labelContent += `${start}\t${end}\t${label}\n`;
            });
            return labelContent;
        }

        /**
         * 秒数を「X分Y.Z秒」の形式にフォーマットする
         * @param {number} totalSeconds
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = (totalSeconds % 60).toFixed(2); // 小数点以下2桁
            
            if (minutes > 0) {
                return `${minutes}分${seconds}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

    </script>
</body>
</html>